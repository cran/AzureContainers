<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">



<title>Deploying a prediction service with Microsoft Machine Learning Server</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Deploying a prediction service with Microsoft Machine Learning Server</h1>



<p>This document shows how you can deploy a fitted model as a web service using ACR and AKS. The framework used is <a href="https://www.microsoft.com/en-us/sql-server/machinelearningserver">Microsoft Machine Learning Server</a>. The process is broadly similar to that for deploying a Plumber service, as described in the “Plumber model deployment” vignette. If you haven’t already, you should read that vignette first as an introduction to how to use AzureContainers.</p>
<div id="model-operationalisation-with-ml-server" class="section level2">
<h2>Model operationalisation with ML Server</h2>
<p>ML Server ships with a sophisticated framework for model management and deployment. The more relevant features for this vignette are:</p>
<ul>
<li><p>When you define a prediction service, you actually upload your model and script to a database; this allows multiple versions/generations of a model to be stored and managed easily.</p></li>
<li><p>A prediction service automatically includes the ability to handle both synchronous and asynchronous (batch) requests without requiring any extra work on your part.</p></li>
<li><p>Authentication is similarly included; to use a service, users must either supply a username and password, or authenticate with Azure Active Directory.</p></li>
</ul>
<p>In addition to the above features, ML Server includes comprehensive facilities to manage a server pool and do load balancing. For the purposes of this vignette, we’ll let Kubernetes handle these issues. More information can be obtained from the <a href="https://docs.microsoft.com/en-us/machine-learning-server/operationalize/how-to-deploy-web-service-publish-manage-in-r">relevant pages on docs.microsoft.com</a>.</p>
<p>Unlike Plumber, ML Server is proprietary software. However, if you have a Microsoft SQL Server license, you will generally also have access to ML Server. There is also a development license that can be used for free.</p>
</div>
<div id="deployment-artifacts" class="section level2">
<h2>Deployment artifacts</h2>
<p>For illustrative purposes, we’ll reuse the random forest model from the Plumber deployment vignette. The artifacts for deploying this model using ML Server are listed here.</p>
<div id="model-building-script" class="section level3">
<h3>Model building script</h3>
<p>This is unchanged from the Plumber vignette, and is run offline.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">data</span>(Boston, <span class="dt">package=</span><span class="st">&quot;MASS&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">install.packages</span>(<span class="st">&quot;randomForest&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(randomForest)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># train a model for median house price as a function of the other variables</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>bos_rf &lt;-<span class="st"> </span><span class="kw">randomForest</span>(medv <span class="op">~</span><span class="st"> </span>., <span class="dt">data=</span>Boston, <span class="dt">ntree=</span><span class="dv">100</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># save the model</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">saveRDS</span>(bos.rf, <span class="st">&quot;bos_rf.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="scoring-and-deployment-script" class="section level3">
<h3>Scoring and deployment script</h3>
<p>This script is run at container startup. The script initialises the prediction service using the <code>publishService</code> function, passing the model object and scoring function as arguments. A version number is also provided; it’s possible to expose multiple models in the same service distinguished by this parameter.</p>
<p>Note that unlike Plumber, the R process that runs this script is <em>not</em> persistent. Rather, it calls the ML Server operationalisation service which in turn manages a number of separate, background R processes. It is these processes that handle incoming requests, using the information supplied in the <code>publishService</code> call.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># save as bos_rf_mls_deploy.R</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>bos_rf &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;bos_rf.rds&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a>bos_rf_score &lt;-<span class="st"> </span><span class="cf">function</span>(inputData)</span>
<span id="cb2-5"><a href="#cb2-5"></a>{</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="kw">require</span>(randomForest)</span>
<span id="cb2-7"><a href="#cb2-7"></a>    inputData &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(inputData)</span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="kw">predict</span>(bos_rf, inputData)</span>
<span id="cb2-9"><a href="#cb2-9"></a>}</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="kw">library</span>(mrsdeploy)</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># make sure you use a strong password or Azure Active Directory authentication in production</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="kw">remoteLogin</span>(<span class="st">&quot;http://localhost:12800&quot;</span>, <span class="dt">username=</span><span class="st">&quot;admin&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Microsoft@2018&quot;</span>, <span class="dt">session=</span><span class="ot">FALSE</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a>api &lt;-<span class="st"> </span><span class="kw">publishService</span>(<span class="st">&quot;bos-rf&quot;</span>, <span class="dt">v=</span><span class="st">&quot;1.0.0&quot;</span>,</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="dt">code=</span>bos_rf_score,</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="dt">model=</span>bos_rf,</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="dt">inputs=</span><span class="kw">list</span>(<span class="dt">inputData=</span><span class="st">&quot;data.frame&quot;</span>),</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="dt">outputs=</span><span class="kw">list</span>(<span class="dt">pred=</span><span class="st">&quot;vector&quot;</span>))</span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="kw">remoteLogout</span>()</span></code></pre></div>
</div>
<div id="dockerfile" class="section level3">
<h3>Dockerfile</h3>
<p>This Dockerfile installs the Azure CLI (which is needed to initialise the operationalisation feature) and a cut-down version of ML Server that includes only the core Microsoft R packages. It omits the Python portion, as well as the pre-built machine learning models. This reduces the size of the image to about 2GB, as opposed to 9.8GB for a full install.</p>
<p>Some other differences of note from the Plumber Dockerfile:</p>
<ul>
<li>The base image is Ubuntu, rather than one from the Rocker project. As this doesn’t include the C and Fortran compilers required to install randomForest, we have to add them explicitly.</li>
<li>It’s necessary to modify some of ML Server’s config files to enable it to work in a Kubernetes cluster. In particular, we have to supply a certificate so that different nodes in the cluster can recognise each other. Here, we use a certificate supplied by Microsoft; in a production setting, you should <a href="https://blogs.msdn.microsoft.com/mlserver/2017/05/19/using-certificates-in-r-server-operationalization-for-linux/">use your own</a>.</li>
<li>The startup command does more work than in the Plumber case, where it simply started R and called a Plumber function. Here, it initialises the operationalisation web and compute nodes, starts R, and calls the deployment script.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Dockerfile for one-box deployment</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">FROM</span> ubuntu:16.04</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">RUN</span> apt-get -y update \</span>
<span id="cb3-4"><a href="#cb3-4"></a>    &amp;&amp; apt-get install -y apt-transport-https wget \</span>
<span id="cb3-5"><a href="#cb3-5"></a>    &amp;&amp; echo <span class="st">&quot;deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ xenial main&quot;</span> | tee /etc/apt/sources.list.d/azure-cli.list \</span>
<span id="cb3-6"><a href="#cb3-6"></a>    &amp;&amp; wget https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb -O /tmp/prod.deb \</span>
<span id="cb3-7"><a href="#cb3-7"></a>    &amp;&amp; dpkg -i /tmp/prod.deb \</span>
<span id="cb3-8"><a href="#cb3-8"></a>    &amp;&amp; rm -f /tmp/prod.deb \</span>
<span id="cb3-9"><a href="#cb3-9"></a>    &amp;&amp; apt-key adv --keyserver packages.microsoft.com --recv-keys 52E16F86FEE04B979B07E28DB02C46DF417A0893 \</span>
<span id="cb3-10"><a href="#cb3-10"></a>    &amp;&amp; apt-get -y update \</span>
<span id="cb3-11"><a href="#cb3-11"></a>    &amp;&amp; apt-get install -y microsoft-r-open-foreachiterators-3.4.3 \</span>
<span id="cb3-12"><a href="#cb3-12"></a>    &amp;&amp; apt-get install -y microsoft-r-open-mkl-3.4.3 \</span>
<span id="cb3-13"><a href="#cb3-13"></a>    &amp;&amp; apt-get install -y microsoft-r-open-mro-3.4.3 \</span>
<span id="cb3-14"><a href="#cb3-14"></a>    &amp;&amp; apt-get install -y microsoft-mlserver-packages-r-9.3.0 \</span>
<span id="cb3-15"><a href="#cb3-15"></a>    &amp;&amp; apt-get install -y azure-cli=2.0.26-1~xenial \</span>
<span id="cb3-16"><a href="#cb3-16"></a>    &amp;&amp; apt-get install -y dotnet-runtime-2.0.0 \</span>
<span id="cb3-17"><a href="#cb3-17"></a>    &amp;&amp; apt-get install -y microsoft-mlserver-adminutil-9.3.0 \</span>
<span id="cb3-18"><a href="#cb3-18"></a>    &amp;&amp; apt-get install -y microsoft-mlserver-config-rserve-9.3.0 \</span>
<span id="cb3-19"><a href="#cb3-19"></a>    &amp;&amp; apt-get install -y microsoft-mlserver-computenode-9.3.0 \</span>
<span id="cb3-20"><a href="#cb3-20"></a>    &amp;&amp; apt-get install -y microsoft-mlserver-webnode-9.3.0 \</span>
<span id="cb3-21"><a href="#cb3-21"></a>    &amp;&amp; apt-get clean \</span>
<span id="cb3-22"><a href="#cb3-22"></a>    &amp;&amp; /opt/microsoft/mlserver/9.3.0/bin/R/activate.sh</span>
<span id="cb3-23"><a href="#cb3-23"></a></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="co"># install C and Fortran compilers, needed for randomForest</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="kw">RUN</span> apt-get install -y make gcc gfortran</span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="kw">RUN</span> Rscript -e <span class="st">&quot;install.packages(&#39;randomForest&#39;)&quot;</span></span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co"># copy model and one-box deployment script</span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="kw">RUN</span> mkdir /data</span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="kw">COPY</span> bos_rf_mls_deploy.R /data</span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="kw">COPY</span> bos_rf.rds /data</span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="kw">WORKDIR</span> /data</span>
<span id="cb3-34"><a href="#cb3-34"></a></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="kw">RUN</span> echo $<span class="st">&#39;#!/bin/bash \n\</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="st">set -e \n\</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="st">/opt/microsoft/mlserver/9.3.0/o16n/startAll.sh \n\</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="st">/opt/microsoft/mlserver/9.3.0/o16n/Microsoft.MLServer.ComputeNode/autoStartScriptsLinux/computeNode.sh start \n\</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="st">az ml admin node setup --webnode --admin-password &quot;Microsoft@2018&quot; --confirm-password &quot;Microsoft@2018&quot; --uri http://localhost:12805 \n\</span></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="st">/usr/bin/Rscript --no-save --verbose bos_rf_mls_deploy.R \n\</span></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="st">sleep infinity&#39;</span> &gt; bootstrap.sh</span>
<span id="cb3-42"><a href="#cb3-42"></a></span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="kw">RUN</span> chmod +x bootstrap.sh</span>
<span id="cb3-44"><a href="#cb3-44"></a></span>
<span id="cb3-45"><a href="#cb3-45"></a></span>
<span id="cb3-46"><a href="#cb3-46"></a><span class="co">#### Modifications to config files to run onebox in Kubernetes</span></span>
<span id="cb3-47"><a href="#cb3-47"></a></span>
<span id="cb3-48"><a href="#cb3-48"></a><span class="kw">RUN</span> echo $<span class="st">&#39;library(jsonlite) \n\</span></span>
<span id="cb3-49"><a href="#cb3-49"></a><span class="st"> \n\</span></span>
<span id="cb3-50"><a href="#cb3-50"></a><span class="st">settings_file &lt;- &quot;/opt/microsoft/mlserver/9.3.0/o16n/Microsoft.MLServer.WebNode/appsettings.json&quot; \n\</span></span>
<span id="cb3-51"><a href="#cb3-51"></a><span class="st">settings &lt;- fromJSON(settings_file) \n\</span></span>
<span id="cb3-52"><a href="#cb3-52"></a><span class="st"> \n\</span></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="st">settings$Authentication$JWTSigningCertificate$Enabled &lt;- TRUE \n\</span></span>
<span id="cb3-54"><a href="#cb3-54"></a><span class="st">settings$Authentication$JWTSigningCertificate$StoreName &lt;- &quot;Root&quot; \n\</span></span>
<span id="cb3-55"><a href="#cb3-55"></a><span class="st">settings$Authentication$JWTSigningCertificate$StoreLocation &lt;- &quot;CurrentUser&quot; \n\</span></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="st">settings$Authentication$JWTSigningCertificate$SubjectName &lt;- &quot;CN=LOCALHOST&quot; \n\</span></span>
<span id="cb3-57"><a href="#cb3-57"></a><span class="st"> \n\</span></span>
<span id="cb3-58"><a href="#cb3-58"></a><span class="st">writeLines(toJSON(settings, auto_unbox=TRUE, pretty=TRUE), settings_file) \n\</span></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="st">&#39;</span> &gt; configure_jwt_cert.R</span>
<span id="cb3-60"><a href="#cb3-60"></a></span>
<span id="cb3-61"><a href="#cb3-61"></a><span class="kw">RUN</span> chmod +x configure_jwt_cert.R</span>
<span id="cb3-62"><a href="#cb3-62"></a></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co"># insert your own cert here</span></span>
<span id="cb3-64"><a href="#cb3-64"></a><span class="kw">RUN</span> sed -i <span class="st">&#39;s/grep docker/grep &quot;kubepods\\|docker&quot;/g&#39;</span> /opt/microsoft/mlserver/9.3.0/o16n/Microsoft.MLServer.*Node/autoStartScriptsLinux/*.sh \</span>
<span id="cb3-65"><a href="#cb3-65"></a>    &amp;&amp; mkdir -p /home/webnode_usr/.dotnet/corefx/cryptography/x509stores/root \</span>
<span id="cb3-66"><a href="#cb3-66"></a>    &amp;&amp; wget https://github.com/Microsoft/microsoft-r/raw/master/mlserver-arm-templates/enterprise-configuration/linux-postgresql/25706AA4612FC42476B8E6C72A97F58D4BB5721B.pfx -O /home/webnode_usr/.dotnet/corefx/cryptography/x509stores/root/25706AA4612FC42476B8E6C72A97F58D4BB5721B.pfx \</span>
<span id="cb3-67"><a href="#cb3-67"></a>    &amp;&amp; chmod 666 /home/webnode_usr/.dotnet/corefx/cryptography/x509stores/root/*.pfx \</span>
<span id="cb3-68"><a href="#cb3-68"></a>    &amp;&amp; /usr/bin/Rscript configure_jwt_cert.R</span>
<span id="cb3-69"><a href="#cb3-69"></a></span>
<span id="cb3-70"><a href="#cb3-70"></a><span class="co">####</span></span>
<span id="cb3-71"><a href="#cb3-71"></a></span>
<span id="cb3-72"><a href="#cb3-72"></a><span class="kw">EXPOSE</span> 12800</span>
<span id="cb3-73"><a href="#cb3-73"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;/data/bootstrap.sh&quot;</span>]</span></code></pre></div>
</div>
<div id="kubernetes-deployment-file" class="section level3">
<h3>Kubernetes deployment file</h3>
<p>The yaml file for the ML Server deployment is essentially identical to that for Plumber, with only the names and port number being changed.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># save as bos-rf-mls.yaml</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> extensions/v1beta1</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bos-rf-mls</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> bos-rf-mls</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bos-rf-mls</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> deployreg.azurecr.io/bos-rf-mls</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">12800</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="at">        </span><span class="fu">resources</span><span class="kw">:</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="at">          </span><span class="fu">requests</span><span class="kw">:</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 250m</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="at">          </span><span class="fu">limits</span><span class="kw">:</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="at">            </span><span class="fu">cpu</span><span class="kw">:</span><span class="at"> 500m</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="at">      </span><span class="fu">imagePullSecrets</span><span class="kw">:</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> deployreg.azurecr.io</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="pp">---</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> bos-rf-mls-svc</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> bos-rf-mls</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> LoadBalancer</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="at">    </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">12800</span></span></code></pre></div>
</div>
</div>
<div id="deploying-the-service" class="section level2">
<h2>Deploying the service</h2>
<p>The script for deploying to Kubernetes, given the above artifacts, is very simple. This reuses the ACR and AKS resources created in the Plumber vignette.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">library</span>(AzureContainers)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>deployresgrp &lt;-<span class="st"> </span>AzureRMR<span class="op">::</span><span class="kw">get_azure_login</span>()<span class="op">$</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">    </span><span class="kw">get_subscription</span>(<span class="st">&quot;sub_id&quot;</span>)<span class="op">$</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">    </span><span class="kw">get_resource_group</span>(<span class="st">&quot;deployresgrp&quot;</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co"># get container registry</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>deployreg &lt;-<span class="st"> </span>deployresgrp<span class="op">$</span><span class="kw">get_acr</span>(<span class="st">&quot;deployreg&quot;</span>)<span class="op">$</span><span class="kw">get_docker_registry</span>()</span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co"># build and upload image</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="kw">call_docker</span>(<span class="st">&quot;build -t bos-rf-mls .&quot;</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a>deployreg<span class="op">$</span><span class="kw">push</span>(<span class="st">&quot;bos-rf-mls&quot;</span>)</span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co"># get the Kubernetes cluster endpoint</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>deployclus &lt;-<span class="st"> </span>deployresgrp<span class="op">$</span><span class="kw">get_aks</span>(<span class="st">&quot;deployclus&quot;</span>)<span class="op">$</span><span class="kw">get_cluster</span>()</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co"># create and start the service</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>deployclus<span class="op">$</span><span class="kw">create</span>(<span class="st">&quot;bos-rf-mls.yaml&quot;</span>)</span></code></pre></div>
</div>
<div id="calling-the-service" class="section level2">
<h2>Calling the service</h2>
<p>It’s possible to call an ML Server prediction service in either synchronous or asynchronous mode. First, we’ll show the synchronous case. We login to the server to get an authentication token, and then call the service URI itself. The path in the URI includes the service name and version we supplied in the <code>publishService</code> function call previously.</p>
<p>Note also that ML Server returns a comprehensive response object, that includes the actual predicted values as a component. For more information, see <a href="https://docs.microsoft.com/en-us/machine-learning-server/operationalize/concept-api">docs.microsoft.com</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># get status of the service, including the IP address</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>deployclus<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;service bos-rf-mls-svc&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; Kubernetes operation: get service bos-rf-svc  --kubeconfig=&quot;.../kubeconfigxxxx&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt; NAME         TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)           AGE</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt; bos-rf-svc   LoadBalancer   10.0.107.147   52.187.245.39   12800:30365/TCP   5m </span></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># obtain an authentication token from the server</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>response &lt;-<span class="st"> </span><span class="kw">POST</span>(<span class="st">&quot;http://52.187.245.39:12800/login/&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="dt">body=</span><span class="kw">list</span>(<span class="dt">username=</span><span class="st">&quot;admin&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Microsoft@2018&quot;</span>),</span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="dt">encode=</span><span class="st">&quot;json&quot;</span>)</span>
<span id="cb6-11"><a href="#cb6-11"></a>token &lt;-<span class="st"> </span><span class="kw">content</span>(response)<span class="op">$</span>access_token</span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co"># do the prediction, passing input values in the request body</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>bos_json &lt;-<span class="st"> </span>jsonlite<span class="op">::</span><span class="kw">toJSON</span>(<span class="kw">list</span>(<span class="dt">inputData=</span>MASS<span class="op">::</span>Boston[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,]),</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="dt">dataframe=</span><span class="st">&quot;columns&quot;</span>)</span>
<span id="cb6-16"><a href="#cb6-16"></a>response &lt;-<span class="st"> </span><span class="kw">POST</span>(<span class="st">&quot;http://52.187.245.39:12800/api/bos-rf/1.0.0&quot;</span>,</span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="kw">add_headers</span>(<span class="dt">Authorization=</span><span class="kw">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, token),</span>
<span id="cb6-18"><a href="#cb6-18"></a>        <span class="st">`</span><span class="dt">content-type</span><span class="st">`</span>=<span class="st">&quot;application/json&quot;</span>),</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="dt">body=</span>bos_json)</span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="kw">content</span>(response, <span class="dt">simplifyVector=</span><span class="ot">TRUE</span>)<span class="op">$</span>outputParameters<span class="op">$</span>pred</span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt; [1] 25.9269 22.0636 34.1876 33.7737 34.8081 27.6394 21.8007 22.3577 16.7812 18.9785</span></span></code></pre></div>
<p>To make an asynchronous (batch) request, we simply change the URI and pass a <em>list</em> of model inputs. The reason for passing a list is because, when in batch mode, ML Server can process multiple inputs in parallel from the one request. Here, we pass the first 20 rows of the Boston dataset as two sets of 10 rows each. We also set the number of threads that ML Server will use to two, via the <code>parallelCount</code> query parameter in the URI.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>bos_json_list &lt;-<span class="st"> </span>jsonlite<span class="op">::</span><span class="kw">toJSON</span>(<span class="kw">list</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>        <span class="kw">list</span>(<span class="dt">inputData=</span>MASS<span class="op">::</span>Boston[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,]),</span>
<span id="cb7-3"><a href="#cb7-3"></a>        <span class="kw">list</span>(<span class="dt">inputData=</span>MASS<span class="op">::</span>Boston[<span class="dv">11</span><span class="op">:</span><span class="dv">20</span>,])),</span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="dt">dataframe=</span><span class="st">&quot;columns&quot;</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a>response &lt;-<span class="st"> </span><span class="kw">POST</span>(<span class="st">&quot;http://52.187.245.39:12800/api/bos-rf/1.0.0/batch?parallelCount=2&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="kw">add_headers</span>(<span class="dt">Authorization=</span><span class="kw">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, token),</span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="st">`</span><span class="dt">content-type</span><span class="st">`</span>=<span class="st">&quot;application/json&quot;</span>),</span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="dt">body=</span>bos_json_list)</span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="kw">content</span>(response)</span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt; $name</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&gt; [1] &quot;bos-rf&quot;</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#&gt; </span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#&gt; $version</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&gt; [1] &quot;1.0.0&quot;</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&gt; </span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#&gt; $batchExecutionId</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#&gt; [1] &quot;9c6be3d2-f4a0-477b-830d-b07a43403c6e&quot;</span></span></code></pre></div>
<p>Once the request has been sent, we can obtain the predicted values by querying the server again, passing the batch execution ID as a parameter:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>response &lt;-<span class="st"> </span><span class="kw">GET</span>(<span class="st">&quot;http://52.187.245.39:12800/api/bos-rf/1.0.0/batch/9c6be3d2-f4a0-477b-830d-b07a43403c6e&quot;</span>,</span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="kw">add_headers</span>(<span class="dt">Authorization=</span><span class="kw">paste0</span>(<span class="st">&quot;Bearer &quot;</span>, token),</span>
<span id="cb8-3"><a href="#cb8-3"></a>        <span class="st">`</span><span class="dt">content-type</span><span class="st">`</span>=<span class="st">&quot;application/json&quot;</span>))</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">content</span>(response, <span class="dt">simplifyVector=</span><span class="ot">TRUE</span>)<span class="op">$</span>batchExecutionResults<span class="op">$</span>outputParameters</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt;                                                                                                 pred</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt; 1 25.92692, 22.06357, 34.18765, 33.77370, 34.80810, 27.63945, 21.80073, 22.35773, 16.78120, 18.97845</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt; 2 17.22610, 20.05682, 21.63635, 20.13023, 18.69370, 20.14845, 22.33917, 17.92152, 19.33282, 18.75947</span></span></code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
